---
- name: copy template files
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: ntp.conf.j2, dest: /etc/ntp.conf }
    - { src: 50-server.cnf.j2, dest: /etc/mysql/mariadb.conf.d/50-server.cnf }
    - { src: memcached.conf.j2, dest: /etc/memcached.conf }

- rabbitmq_user:
    user: openstack
    permissions:
      - vhost: /
        configure_priv: .*
        read_priv: .*
        write_priv: .*
    state: present

- name: restart services
  systemd:
    state: restarted
    daemon_reload: yes
    name: "{{ item }}"
  with_items:
    - ntp
    - mariadb
    - rabbitmq-server

- name: "mysql_secure_installation"
  expect:
    command: /usr/bin/mysql_secure_installation
    responses:
      "Enter current password for root \\(enter for none\\): " : ""
      "Set root password\\? \\[Y\\/n\\] " : "Y"
      "New password: " : "ubueru1004"
      "Re-enter new password: " : "ubueru1004"
      "Remove anonymous users\\?" : "y"
      "Disallow root login remotely\\?" : "y"
      "Remove test database and access to it\\?" : "y"
      "Reload privilege tables now\\?" : "y"